name: Versioning and relese URL
on:
  workflow_call:
    secrets:
      BUILD_MACHINE_TOKEN:
        required: true
    input:
      release_tag:
        required: true
        type: string
    outputs:
      upload_url:
        description: "URL to release"
        value: ${{ jobs.create_release.outputs.upload_url }}

jobs:
  create_release:
    timeout-minutes: 5
    runs-on: [self-hosted]
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.BUILD_MACHINE_TOKEN }}
          RELEASE_PATH: ../../releases/download/${{steps.version.outputs.version}}
        with:
          tag_name: ${{steps.version.outputs.version }}
          release_name: Release ${{steps.version.outputs.version}}
          draft: false
          prerelease: false
          body: |
            Autogenerated release
            <table>
              <thead>
                <tr>
                  <th>OS</th>
                  <th>Release</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td align="center">Windows x64</td>
                  <td align="center">
                    <a href="${{env.RELEASE_PATH}}/MeshInspectorInstaller_${{steps.version.outputs.version}}.msi">msi</a>
                  </td>
                </tr>
                <tr>
                  <td align="center">Ubuntu 20 LTS x64</td>
                  <td align="center">
                    <a href="${{env.RELEASE_PATH}}/meshinspector_${{steps.version.outputs.version}}.deb">deb</a>
                  </td>
                </tr>
                <tr>
                  <td align="center">Fedora 35 x64</td>
                  <td align="center">
                    <a href="${{env.RELEASE_PATH}}/meshinspector_${{steps.version.outputs.version}}.rpm">rpm</a>
                  </td>
                </tr>
                <tr>
                  <td align="center">MacOS</td>
                  <td colspan=3 align="center"> Coming soon! :green_apple:</td>
                </tr>
              </tbody>
            </table>